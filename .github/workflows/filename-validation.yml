name: File Name Validator

on:
  pull_request:
    branches:
      - main
    paths:
      - daily/**
      - weekly/**
      - monthly/**
      - yearly/**

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-file-names:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v35

      - name: Validate file names and CSV content
        run: |
          echo "üîç Validating file names and CSV content..."

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Checking file: $file"

            filename=$(basename "$file")

            # REMOVE EXTENSION CHECK ‚Äî user uploads WITHOUT .csv
            # Instead, check if the file CONTENT looks like CSV
            echo "‚û° Checking if file content is CSV..."

            # Content-based CSV detection: must contain at least ONE comma
            if ! grep -q "," "$file"; then
              echo "‚ùå ERROR: File content is NOT CSV (missing commas)"
              exit 1
            fi

            # Validate filename format without extension
            # Pattern: <serial> <year> <count>_<event> <month>
            regex="^([0-9]+)\s([0-9]{4})\s([0-9]+)_(day|week|month|year)\s([A-Za-z]+)$"

            # Strip extension if user adds any accidentally
            name_without_ext="${filename%.*}"

            if [[ ! "$name_without_ext" =~ $regex ]]; then
              echo "‚ùå ERROR: Invalid filename format ‚Üí $filename"
              exit 1
            fi

            serial="${BASH_REMATCH[1]}"
            year="${BASH_REMATCH[2]}"
            count="${BASH_REMATCH[3]}"
            event="${BASH_REMATCH[4]}"
            month="${BASH_REMATCH[5]}"

            # Folder validation
            if [[ "$file" == daily/* && "$event" != "day" ]]; then
              echo "‚ùå ERROR: Daily folder accepts only *_day filenames"
              exit 1
            fi

            if [[ "$file" == weekly/* && "$event" != "week" ]]; then
              echo "‚ùå ERROR: Weekly folder accepts only *_week filenames"
              exit 1
            fi

            if [[ "$file" == monthly/* && "$event" != "month" ]]; then
              echo "‚ùå ERROR: Monthly folder accepts only *_month filenames"
              exit 1
            fi

            if [[ "$file" == yearly/* && "$event" != "year" ]]; then
              echo "‚ùå ERROR: Yearly folder accepts only *_year filenames"
              exit 1
            fi

            # Yearly strict rule
            if [[ "$file" == yearly/* ]]; then
              if [[ "$count" != "1" ]]; then
                echo "‚ùå ERROR: Yearly folder must always have count '1'"
                exit 1
              fi
            fi

            echo "‚úî FILE IS VALID ‚Üí $filename"
          done

          echo "üéâ All files successfully validated!"
