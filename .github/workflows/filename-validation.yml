name: File Name Validator

on:
  pull_request:
    paths:
      - "**"

jobs:
  validate-file-names:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get changed files (WITH SPACES SUPPORT)
        id: changed
        uses: tj-actions/changed-files@v35
        with:
          separator: "|"

      - name: Validate file names and CSV content
        run: |
          echo "üîç Validating files..."

          IFS="|" read -ra files <<< "${{ steps.changed.outputs.all_changed_files }}"

          echo "Changed files detected:"
          printf '%s\n' "${files[@]}"

          # Loop through each changed file
          for file in "${files[@]}"; do

            # Validate only files inside data folders
            if [[ "$file" != daily/* && "$file" != weekly/* && "$file" != monthly/* && "$file" != yearly/* ]]; then
              echo "‚Ñπ Skipping non-data file: $file"
              continue
            fi

            echo "----------------------------------------"
            echo "Checking file: $file"

            # Extract filename only (with spaces)
            filename="$(basename "$file")"
            name_without_ext="${filename%.*}"

            echo "‚û° Filename (no extension): $name_without_ext"

            # REGEX: <serial> <year> <count>_<event> <month>
            regex="^([0-9]+)\s([0-9]{4})\s([0-9]+)_(day|week|month|year)\s([A-Za-z]+)$"

            if [[ ! "$name_without_ext" =~ $regex ]]; then
              echo "‚ùå ERROR: Invalid filename format ‚Üí $filename"
              exit 1
            fi

            serial="${BASH_REMATCH[1]}"
            year="${BASH_REMATCH[2]}"
            count="${BASH_REMATCH[3]}"
            event="${BASH_REMATCH[4]}"
            month="${BASH_REMATCH[5]}"

            echo "‚úî Filename format OK"
            echo "‚û° serial: $serial, year: $year, count: $count, event: $event, month: $month"

            # Folder ‚Üí event matching rules
            if [[ "$file" == daily/* && "$event" != "day" ]]; then
              echo "‚ùå ERROR: daily folder accepts only *_day files"
              exit 1
            fi

            if [[ "$file" == weekly/* && "$event" != "week" ]]; then
              echo "‚ùå ERROR: weekly folder accepts only *_week files"
              exit 1
            fi

            if [[ "$file" == monthly/* && "$event" != "month" ]]; then
              echo "‚ùå ERROR: monthly folder accepts only *_month files"
              exit 1
            fi

            if [[ "$file" == yearly/* && "$event" != "year" ]]; then
              echo "‚ùå ERROR: yearly folder accepts only *_year files"
              exit 1
            fi

            # Yearly count rule
            if [[ "$file" == yearly/* && "$count" != "1" ]]; then
              echo "‚ùå ERROR: yearly files must always have count = 1"
              exit 1
            fi

            echo "‚û° Checking content: must contain at least one comma"

            if ! grep -q "," "$file"; then
              echo "‚ùå ERROR: File content is NOT CSV (missing commas)"
              exit 1
            fi

            echo "‚úî CSV content OK"
            echo "‚úî FILE VALID: $file"

          done

          echo "üéâ ALL FILES VALID"
